<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>徐氏松茂堂 - 数字化族谱</title>
    <!-- 使用国内 CDN 加速 D3.js 加载 -->
    <script src="https://lib.baomitu.com/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: "Microsoft YaHei", "Heiti SC", sans-serif;
            background-color: #f0f2f5;
        }

        #tree-container {
            width: 100vw;
            height: 100vh;
        }

        .node circle {
            fill: #fff;
            stroke: #555;
            stroke-width: 1.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node circle:hover {
            stroke: #1890ff; 
            stroke-width: 3px;
            fill: #e6f7ff;
        }

        .node text {
            font: 18px "Microsoft YaHei", sans-serif; /* 加大字体 */
            font-weight: 500;
            cursor: pointer;
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
        }

        .link {
            fill: none;
            stroke: #999;
            stroke-width: 1.5px;
            transition: all 0.5s ease;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: transparent; 
            padding: 0;
            box-shadow: none;
            z-index: 100;
        }
        
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 18px; 
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        button:hover {
            background: #40a9ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>

<div id="controls">
    <button onclick="expandAll()">全部展开</button>
    <button onclick="collapseAll()">全部收起</button>
</div>

<div id="tree-container"></div>

<script>
    // --- 族谱数据 ---
    const rawData = [
  {
    "name": "始祖 崇公(定俸公)",
    "children": [
      {
        "name": "二世祖 明昌公",
        "children": [
          {
            "name": "三世祖 旋台公",
            "children": [
              {
                "name": "四世祖 京宗公",
                "children": [
                  {
                    "name": "国禄公"
                  },
                  {
                    "name": "国辅公"
                  },
                  {
                    "name": "五世祖 国显公(隆书公)",
                    "children": [
                      {
                        "name": "六世祖 碧天公",
                        "children": [
                          {
                            "name": "七世祖 朝彦公",
                            "children": [
                              {
                                "name": "长房 敏公"
                              },
                              {
                                "name": "二房 犖公"
                              },
                              {
                                "name": "三房 鸿公",
                                "children": [
                                  {
                                    "name": "舒璘公",
                                    "children": [
                                      {
                                        "name": "元文公",
                                        "children": [
                                          {
                                            "name": "雍邦公",
                                            "children": [
                                              {
                                                "name": "以均公"
                                              }
                                            ]
                                          },
                                          {
                                            "name": "灿邦公"
                                          },
                                          {
                                            "name": "莅邦公",
                                            "children": [
                                              {
                                                "name": "以合公"
                                              }
                                            ]
                                          },
                                          {
                                            "name": "懿邦公",
                                            "children": [
                                              {
                                                "name": "以和公"
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "name": "舒典公",
                                    "children": [
                                      {
                                        "name": "启文公",
                                        "children": [
                                          {
                                            "name": "翼邦公",
                                            "children": [
                                              {
                                                "name": "以升公",
                                                "children": [
                                                  {
                                                    "name": "澄泰公",
                                                    "children": [
                                                      {
                                                        "name": "积峰公"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "name": "以彰公",
                                                "children": [
                                                  {
                                                    "name": "启泰公",
                                                    "children": [
                                                      {
                                                        "name": "积孜公",
                                                        "children": [
                                                          {
                                                            "name": "善海",
                                                            "children": [
                                                              {
                                                                "name": "徐彪",
                                                                "children": [
                                                                  {
                                                                    "name": "亚文"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世荣"
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "name": "更泰公",
                                                    "children": [
                                                      {
                                                        "name": "积称公",
                                                        "children": [
                                                          {
                                                            "name": "善熙"
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "name": "以鼎公"
                                              },
                                              {
                                                "name": "以颖公"
                                              }
                                            ]
                                          }
                                        ]
                                      },
                                      {
                                        "name": "瓒文公",
                                        "children": [
                                          {
                                            "name": "靖邦公",
                                            "children": [
                                              {
                                                "name": "以新公"
                                              },
                                              {
                                                "name": "以联公"
                                              },
                                              {
                                                "name": "以培公"
                                              }
                                            ]
                                          },
                                          {
                                            "name": "存邦公",
                                            "children": [
                                              {
                                                "name": "以谆公"
                                              },
                                              {
                                                "name": "以深公"
                                              },
                                              {
                                                "name": "以浩公",
                                                "children": [
                                                  {
                                                    "name": "初泰公",
                                                    "children": [
                                                      {
                                                        "name": "积森"
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "name": "贤泰公"
                                                  },
                                                  {
                                                    "name": "光泰公",
                                                    "children": [
                                                      {
                                                        "name": "积波",
                                                        "children": [
                                                          {
                                                            "name": "善寿",
                                                            "children": [
                                                              {
                                                                "name": "世凯",
                                                                "children": [
                                                                  {
                                                                    "name": "硕斯"
                                                                  },
                                                                  {
                                                                    "name": "甲斯"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "name": "裕泰公"
                                                  },
                                                  {
                                                    "name": "养泰公"
                                                  },
                                                  {
                                                    "name": "蓝泰公"
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            "name": "永邦公"
                                          }
                                        ]
                                      }
                                    ]
                                  },
                                  {
                                    "name": "舒珍公",
                                    "children": [
                                      {
                                        "name": "成文公",
                                        "children": [
                                          {
                                            "name": "禹邦公",
                                            "children": [
                                              {
                                                "name": "以弼公",
                                                "children": [
                                                  {
                                                    "name": "钰泰公",
                                                    "children": [
                                                      {
                                                        "name": "积煥",
                                                        "children": [
                                                          {
                                                            "name": "善文",
                                                            "children": [
                                                              {
                                                                "name": "世昌",
                                                                "children": [
                                                                  {
                                                                    "name": "朋斯"
                                                                  },
                                                                  {
                                                                    "name": "羽斯",
                                                                    "children": [
                                                                      {
                                                                        "name": "亚大"
                                                                      },
                                                                      {
                                                                        "name": "亚二"
                                                                      },
                                                                      {
                                                                        "name": "亚四"
                                                                      }
                                                                    ]
                                                                  },
                                                                  {
                                                                    "name": "亚四"
                                                                  },
                                                                  {
                                                                    "name": "飞斯"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世明",
                                                                "children": [
                                                                  {
                                                                    "name": "信斯"
                                                                  },
                                                                  {
                                                                    "name": "亚六"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世新",
                                                                "children": [
                                                                  {
                                                                    "name": "亚彬"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善瑞",
                                                            "children": [
                                                              {
                                                                "name": "世忠",
                                                                "children": [
                                                                  {
                                                                    "name": "亚八"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世坚"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善钊"
                                                          },
                                                          {
                                                            "name": "善西",
                                                            "children": [
                                                              {
                                                                "name": "世勇"
                                                              },
                                                              {
                                                                "name": "世丽"
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "name": "滋泰公",
                                                    "children": [
                                                      {
                                                        "name": "积清公",
                                                        "children": [
                                                          {
                                                            "name": "善林",
                                                            "children": [
                                                              {
                                                                "name": "世育",
                                                                "children": [
                                                                  {
                                                                    "name": "炳坤"
                                                                  },
                                                                  {
                                                                    "name": "旭荣"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世葵",
                                                                "children": [
                                                                  {
                                                                    "name": "宁斯"
                                                                  },
                                                                  {
                                                                    "name": "保斯"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善来",
                                                            "children": [
                                                              {
                                                                "name": "世添"
                                                              },
                                                              {
                                                                "name": "世官"
                                                              },
                                                              {
                                                                "name": "世仕"
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积辉公",
                                                        "children": [
                                                          {
                                                            "name": "善松",
                                                            "children": [
                                                              {
                                                                "name": "世楷"
                                                              },
                                                              {
                                                                "name": "世磻",
                                                                "children": [
                                                                  {
                                                                    "name": "徐锋"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世满"
                                                              },
                                                              {
                                                                "name": "世尧"
                                                              },
                                                              {
                                                                "name": "世显"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善柏",
                                                            "children": [
                                                              {
                                                                "name": "宁平"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善喜",
                                                            "children": [
                                                              {
                                                                "name": "世生"
                                                              },
                                                              {
                                                                "name": "世全"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善高",
                                                            "children": [
                                                              {
                                                                "name": "亚海"
                                                              },
                                                              {
                                                                "name": "亚弟"
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "name": "炽泰公(养积辉）"
                                                  },
                                                  {
                                                    "name": "能泰公",
                                                    "children": [
                                                      {
                                                        "name": "积家",
                                                        "children": [
                                                          {
                                                            "name": "善成",
                                                            "children": [
                                                              {
                                                                "name": "世堂",
                                                                "children": [
                                                                  {
                                                                    "name": "徐伟"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积期"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "name": "以寿公",
                                                "children": [
                                                  {
                                                    "name": "煜泰公",
                                                    "children": [
                                                      {
                                                        "name": "积兴",
                                                        "children": [
                                                          {
                                                            "name": "善芬",
                                                            "children": [
                                                              {
                                                                "name": "世谷",
                                                                "children": [
                                                                  {
                                                                    "name": "金配",
                                                                    "children": [
                                                                      {
                                                                        "name": "亚弟"
                                                                      }
                                                                    ]
                                                                  },
                                                                  {
                                                                    "name": "铭军"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世康",
                                                                "children": [
                                                                  {
                                                                    "name": "石权",
                                                                    "children": [
                                                                      {
                                                                        "name": "亚弟"
                                                                      }
                                                                    ]
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积汉",
                                                        "children": [
                                                          {
                                                            "name": "善贞"
                                                          },
                                                          {
                                                            "name": "善坤",
                                                            "children": [
                                                              {
                                                                "name": "世夫",
                                                                "children": [
                                                                  {
                                                                    "name": "钊斯"
                                                                  },
                                                                  {
                                                                    "name": "烽斯"
                                                                  },
                                                                  {
                                                                    "name": "松斯"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世忠",
                                                                "children": [
                                                                  {
                                                                    "name": "木合"
                                                                  },
                                                                  {
                                                                    "name": "柱斯"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积玉",
                                                        "children": [
                                                          {
                                                            "name": "善针",
                                                            "children": [
                                                              {
                                                                "name": "世杰",
                                                                "children": [
                                                                  {
                                                                    "name": "启忠"
                                                                  },
                                                                  {
                                                                    "name": "金全"
                                                                  },
                                                                  {
                                                                    "name": "海全"
                                                                  },
                                                                  {
                                                                    "name": "柱华"
                                                                  },
                                                                  {
                                                                    "name": "棋斯"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善汉",
                                                            "children": [
                                                              {
                                                                "name": "伟林",
                                                                "children": [
                                                                  {
                                                                    "name": "坤胜"
                                                                  },
                                                                  {
                                                                    "name": "金宏"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世列"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善本",
                                                            "children": [
                                                              {
                                                                "name": "世心",
                                                                "children": [
                                                                  {
                                                                    "name": "海兵"
                                                                  },
                                                                  {
                                                                    "name": "海勇"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积蟾",
                                                        "children": [
                                                          {
                                                            "name": "善良",
                                                            "children": [
                                                              {
                                                                "name": "世健",
                                                                "children": [
                                                                  {
                                                                    "name": "富斯"
                                                                  },
                                                                  {
                                                                    "name": "业斯"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善彬",
                                                            "children": [
                                                              {
                                                                "name": "梧生"
                                                              },
                                                              {
                                                                "name": "穗生",
                                                                "children": [
                                                                  {
                                                                    "name": "火新"
                                                                  },
                                                                  {
                                                                    "name": "桂海"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善强"
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "name": "业泰公",
                                                    "children": [
                                                      {
                                                        "name": "积棣",
                                                        "children": [
                                                          {
                                                            "name": "善芳",
                                                            "children": [
                                                              {
                                                                "name": "养世祥"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善源",
                                                            "children": [
                                                              {
                                                                "name": "徐平"
                                                              },
                                                              {
                                                                "name": "徐军"
                                                              },
                                                              {
                                                                "name": "徐明"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善球",
                                                            "children": [
                                                              {
                                                                "name": "徐华",
                                                                "children": [
                                                                  {
                                                                    "name": "文勇"
                                                                  },
                                                                  {
                                                                    "name": "斯威"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "徐新",
                                                                "children": [
                                                                  {
                                                                    "name": "三弟"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "徐森",
                                                                "children": [
                                                                  {
                                                                    "name": "四弟"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "徐波"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善环"
                                                          },
                                                          {
                                                            "name": "善晋",
                                                            "children": [
                                                              {
                                                                "name": "世铭"
                                                              },
                                                              {
                                                                "name": "徐敏"
                                                              },
                                                              {
                                                                "name": "洪钊"
                                                              },
                                                              {
                                                                "name": "海钊"
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积文(养善球)"
                                                      },
                                                      {
                                                        "name": "积献(养善源)"
                                                      }
                                                    ]
                                                  }
                                                ]
                                              },
                                              {
                                                "name": "以尧公",
                                                "children": [
                                                  {
                                                    "name": "演泰公"
                                                  },
                                                  {
                                                    "name": "钦泰公",
                                                    "children": [
                                                      {
                                                        "name": "积国",
                                                        "children": [
                                                          {
                                                            "name": "善海",
                                                            "children": [
                                                              {
                                                                "name": "日生",
                                                                "children": [
                                                                  {
                                                                    "name": "河斯"
                                                                  },
                                                                  {
                                                                    "name": "徐斯"
                                                                  },
                                                                  {
                                                                    "name": "清云(女)"
                                                                  },
                                                                  {
                                                                    "name": "白云(女)"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "name": "开泰公",
                                                    "children": [
                                                      {
                                                        "name": "积富",
                                                        "children": [
                                                          {
                                                            "name": "善发",
                                                            "children": [
                                                              {
                                                                "name": "忠宝",
                                                                "children": [
                                                                  {
                                                                    "name": "海生",
                                                                    "children": [
                                                                      {
                                                                        "name": "焕长"
                                                                      },
                                                                      {
                                                                        "name": "桂清"
                                                                      }
                                                                    ]
                                                                  },
                                                                  {
                                                                    "name": "梦宇(女)"
                                                                  },
                                                                  {
                                                                    "name": "梅斯(女)"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世乐",
                                                                "children": [
                                                                  {
                                                                    "name": "石新"
                                                                  },
                                                                  {
                                                                    "name": "丹丹(女)"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "徐珍(女)"
                                                              },
                                                              {
                                                                "name": "徐芬(女)"
                                                              },
                                                              {
                                                                "name": "世绵",
                                                                "children": [
                                                                  {
                                                                    "name": "桂康(女)"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善益",
                                                            "children": [
                                                              {
                                                                "name": "海清(女)"
                                                              },
                                                              {
                                                                "name": "超红(女)"
                                                              },
                                                              {
                                                                "name": "桂连(女)"
                                                              },
                                                              {
                                                                "name": "世春",
                                                                "children": [
                                                                  {
                                                                    "name": "梓洋"
                                                                  },
                                                                  {
                                                                    "name": "海棋"
                                                                  },
                                                                  {
                                                                    "name": "晓蓉(女)"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "坤钊"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "善杰",
                                                            "children": [
                                                              {
                                                                "name": "徐兴",
                                                                "children": [
                                                                  {
                                                                    "name": "浩峰"
                                                                  },
                                                                  {
                                                                    "name": "胜海"
                                                                  },
                                                                  {
                                                                    "name": "天龙"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "世科",
                                                                "children": [
                                                                  {
                                                                    "name": "晓玲(女)"
                                                                  },
                                                                  {
                                                                    "name": "晓敏(女)"
                                                                  }
                                                                ]
                                                              },
                                                              {
                                                                "name": "徐双(女)"
                                                              },
                                                              {
                                                                "name": "世学",
                                                                "children": [
                                                                  {
                                                                    "name": "佳婷(女)"
                                                                  },
                                                                  {
                                                                    "name": "龙彬"
                                                                  }
                                                                ]
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "秀英(女)"
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积贵"
                                                      },
                                                      {
                                                        "name": "积荣",
                                                        "children": [
                                                          {
                                                            "name": "秀红(女)"
                                                          },
                                                          {
                                                            "name": "徐彬",
                                                            "children": [
                                                              {
                                                                "name": "活波"
                                                              },
                                                              {
                                                                "name": "桂华"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "秀球(女)"
                                                          },
                                                          {
                                                            "name": "秀玲(女)"
                                                          },
                                                          {
                                                            "name": "徐燕(女)"
                                                          },
                                                          {
                                                            "name": "徐荣",
                                                            "children": [
                                                              {
                                                                "name": "桂花(女)"
                                                              },
                                                              {
                                                                "name": "佳铭"
                                                              },
                                                              {
                                                                "name": "世都"
                                                              }
                                                            ]
                                                          }
                                                        ]
                                                      },
                                                      {
                                                        "name": "积华",
                                                        "children": [
                                                          {
                                                            "name": "秀梅(女)"
                                                          },
                                                          {
                                                            "name": "文中",
                                                            "children": [
                                                              {
                                                                "name": "培杏(女)"
                                                              },
                                                              {
                                                                "name": "世林"
                                                              }
                                                            ]
                                                          },
                                                          {
                                                            "name": "秀珍(女)"
                                                          },
                                                          {
                                                            "name": "秀芬(女)"
                                                          },
                                                          {
                                                            "name": "善文"
                                                          }
                                                        ]
                                                      }
                                                    ]
                                                  }
                                                ]
                                              }
                                            ]
                                          },
                                          {
                                            "name": "启邦公"
                                          },
                                          {
                                            "name": "材邦公"
                                          }
                                        ]
                                      },
                                      {
                                        "name": "轴文公"
                                      },
                                      {
                                        "name": "业文公"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "name": "四房 逵公"
                              },
                              {
                                "name": "五房 超公"
                              },
                              {
                                "name": "六房 辉公"
                              }
                            ]
                          },
                          {
                            "name": "七世祖 朝祯公"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "name": "国聘公"
                  }
                ]
              }
            ]
          },
          {
            "name": "旋般公"
          },
          {
            "name": "旋洁公"
          }
        ]
      },
      {
        "name": "明虏公"
      },
      {
        "name": "明钦公"
      }
    ]
  }
];

    // Configuration
    const width = window.innerWidth;
    const height = window.innerHeight;
    const dx = 45;  // 稍微增大垂直间距以适配大字体
    const dy = 180; // 稍微增大水平间距

    let data;
    if (Array.isArray(rawData)) {
        data = rawData.length === 1 ? rawData[0] : { name: "家族根", children: rawData };
    } else {
        data = rawData;
    }

    const root = d3.hierarchy(data);
    root.x0 = 0;
    root.y0 = 0;

    // 默认折叠
    root.descendants().forEach((d, i) => {
         if(d.depth > 3) {
             if(d.children) {
                 d._children = d.children;
                 d.children = null;
             }
         }
    });

    const svg = d3.select("#tree-container").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, -height / 2, width, height])
        .style("font", "18px Microsoft YaHei")
        .style("user-select", "none");

    const g = svg.append("g");

    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });

    svg.call(zoom)
       // 初始视角调整：靠左显示
       .call(zoom.transform, d3.zoomIdentity.translate(150, 0).scale(0.8));

    const linkGroup = g.append("g").attr("fill", "none").attr("stroke", "#999").attr("stroke-opacity", 0.4).attr("stroke-width", 1.5);
    const nodeGroup = g.append("g").attr("cursor", "pointer").attr("pointer-events", "all");

    update(root);

    function update(source) {
        const duration = 250;
        const nodes = root.descendants().reverse();
        const links = root.links();

        const tree = d3.tree().nodeSize([dx, dy]);
        tree(root);

        const node = nodeGroup.selectAll("g")
            .data(nodes, d => d.id || (d.id = Math.random())); 

        const nodeEnter = node.enter().append("g")
            .attr("transform", d => `translate(${source.y0},${source.x0})`)
            .attr("fill-opacity", 0)
            .attr("stroke-opacity", 0)
            .on("click", (event, d) => {
                if (d.children) {
                    d._children = d.children;
                    d.children = null;
                } else {
                    d.children = d._children;
                    d._children = null;
                }
                update(d);
            });

        nodeEnter.append("circle")
            .attr("r", 7) // 稍微变大一点
            .attr("fill", d => d._children ? "#1890ff" : "#fff")
            .attr("stroke", "#555")
            .attr("stroke-width", 1.5);

        nodeEnter.append("text")
            .attr("dy", "0.31em")
            .attr("x", d => d._children || d.children ? -14 : 14)
            .attr("text-anchor", d => d._children || d.children ? "end" : "start")
            .text(d => d.data.name)
            .clone(true).lower()
            .attr("stroke-linejoin", "round")
            .attr("stroke-width", 3)
            .attr("stroke", "white");

        const nodeUpdate = node.merge(nodeEnter).transition().duration(duration)
            .attr("transform", d => `translate(${d.y},${d.x})`)
            .attr("fill-opacity", 1)
            .attr("stroke-opacity", 1);

        nodeUpdate.select("circle")
            .attr("fill", d => d._children ? "#1890ff" : (d.children ? "#fff" : "#eee")) 
            .attr("stroke", d => d._children ? "#1890ff" : "#555");
            
        nodeUpdate.select("text")
             .attr("x", d => d._children || d.children ? -14 : 14)
             .attr("text-anchor", d => d._children || d.children ? "end" : "start");

        const nodeExit = node.exit().transition().duration(duration).remove()
            .attr("transform", d => `translate(${source.y},${source.x})`)
            .attr("fill-opacity", 0)
            .attr("stroke-opacity", 0);

        const link = linkGroup.selectAll("path")
            .data(links, d => d.target.id);

        const diagonalPath = (s, t) => {
             return `M${s.y},${s.x}
                     C${(s.y + t.y) / 2},${s.x}
                      ${(s.y + t.y) / 2},${t.x}
                      ${t.y},${t.x}`;
        };

        const linkEnter = link.enter().append("path")
            .attr("class", "link")
            .attr("d", d => {
                const o = {x: source.x0, y: source.y0};
                return diagonalPath(o, o);
            });

        link.merge(linkEnter).transition().duration(duration)
            .attr("d", d => diagonalPath(d.source, d.target));

        link.exit().transition().duration(duration).remove()
            .attr("d", d => {
                const o = {x: source.x, y: source.y}; 
                return diagonalPath(o, o);
            });

        root.eachBefore(d => {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    window.expandAll = function() {
        function expand(d) {
            if (d._children) {
                d.children = d._children;
                d._children = null;
            }
            if (d.children) {
                d.children.forEach(expand);
            }
        }
        expand(root);
        update(root);
    }

    window.collapseAll = function() {
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse); 
                d.children = null;
            }
        }
        if(root.children) root.children.forEach(collapse);
        update(root);
        // 【归位逻辑】
        svg.transition()
           .duration(750)
           .call(zoom.transform, d3.zoomIdentity.translate(150, 0).scale(0.8));
    }
</script>

</body>
</html>
